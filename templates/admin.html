<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã - RGG QUEST</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öôÔ∏è</text></svg>">
    <style>
        .map-editor {
            margin-top: 20px;
        }

        .editor-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .editor-mode {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-panel);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .mode-btn.active {
            background: var(--text-accent);
            color: white;
            border-color: var(--text-accent);
        }

        .cell-info {
            padding: 12px;
            background: var(--bg-panel);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-top: 16px;
        }

        .cell-coordinates {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-dark);
            padding: 8px 12px;
            border-radius: 4px;
            margin: 8px 0;
        }

        .editable-map {
            position: relative;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            cursor: crosshair;
        }

        .map-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .map-markers {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .marker {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
            z-index: 20;
        }

        .marker-start {
            width: 20px;
            height: 20px;
            background: var(--text-accent);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 15px var(--text-accent), 0 0 30px rgba(100, 181, 246, 0.5);
            animation: pulse 2s infinite;
        }

        .marker-active {
            width: 12px;
            height: 12px;
            background: var(--text-success);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 8px var(--text-success);
        }

        .marker-checkpoint {
            width: 16px;
            height: 16px;
            background: var(--text-warning);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 12px var(--text-warning);
        }

        .checkpoint-editor {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .checkpoint-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .checkpoint-item {
            padding: 12px;
            background: var(--bg-panel);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .checkpoint-details {
            flex: 1;
        }

        .checkpoint-coords {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .checkpoint-actions {
            display: flex;
            gap: 6px;
        }

        .mini-btn {
            padding: 6px 10px;
            font-size: 0.7em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-remove {
            background: #ef5350;
            color: white;
        }

        .btn-remove:hover {
            background: #d32f2f;
        }

        .btn-edit {
            background: var(--text-accent);
            color: white;
        }

        .btn-edit:hover {
            background: #1976d2;
        }

        .coordinates-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(15, 15, 26, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-accent);
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.8em;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .checkpoint-form {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-panel);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .form-input-small {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            flex: 1;
            min-width: 120px;
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <div class="mobile-menu-toggle" onclick="toggleSidebar()">
        <span>‚ò∞</span>
        <span>–ú–µ–Ω—é</span>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">RGG QUEST</div>
                <div class="sidebar-subtitle">–†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã</div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
                    <a href="/" class="sidebar-link">
                        <span class="sidebar-link-icon">üìã</span>
                        <span class="sidebar-link-text">–ì–ª–∞–≤–Ω–∞—è</span>
                    </a>
                    <a href="/map" class="sidebar-link">
                        <span class="sidebar-link-icon">üó∫Ô∏è</span>
                        <span class="sidebar-link-text">–ö–∞—Ä—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</span>
                    </a>
                    <a href="/archive" class="sidebar-link">
                        <span class="sidebar-link-icon">üìö</span>
                        <span class="sidebar-link-text">–ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á</span>
                    </a>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                    <a href="/admin" class="sidebar-link active">
                        <span class="sidebar-link-icon">‚öôÔ∏è</span>
                        <span class="sidebar-link-text">–†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã</span>
                    </a>
                </div>
            </nav>

            <!-- User Info -->
            <div class="sidebar-user">
                {% if 'username' in session %}
                <div class="user-profile">
                    <div class="user-avatar-large">
                        {{ session.username[0]|upper }}
                    </div>
                    <div class="user-info-compact">
                        <div class="user-name">{{ session.username }}</div>
                        <div class="user-role">{{ session.role }}</div>
                    </div>
                    <a href="/logout" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8em;">–í—ã–π—Ç–∏</a>
                </div>
                {% endif %}
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div style="margin-bottom: 32px;">
                <h1 class="title">–†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã</h1>
                <p class="subtitle">–°–≤–æ–±–æ–¥–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Ç–æ—á–µ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ</p>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-value" id="statActive">0</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ—á–µ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statCheckpoints">0</div>
                    <div class="stat-label">–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statStart">-</div>
                    <div class="stat-label">–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">–°–≤–æ–±–æ–¥–Ω–æ</div>
                    <div class="stat-label">–†–µ–∂–∏–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</div>
                </div>
            </div>

            <form method="POST" action="/admin/save_map" id="map-form">
                <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã -->
                <section class="panel">
                    <h2 class="section-title">üó∫Ô∏è –†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã</h2>

                    <div class="editor-controls">
                        <div class="editor-mode">
                            <span style="color: var(--text-secondary);">–†–µ–∂–∏–º:</span>
                            <button type="button" class="mode-btn active" data-mode="start">
                                üìç –°—Ç–∞—Ä—Ç (–∫–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç–µ)
                            </button>
                            <button type="button" class="mode-btn" data-mode="active">
                                ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞ (–∫–ª–∏–∫)
                            </button>
                            <button type="button" class="mode-btn" data-mode="checkpoint">
                                üèÅ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ (–∫–ª–∏–∫)
                            </button>
                            <button type="button" class="mode-btn" data-mode="delete">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å (–∫–ª–∏–∫ –Ω–∞ –º–∞—Ä–∫–µ—Ä)
                            </button>
                        </div>

                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button type="button" class="btn btn-outline" onclick="clearAllPoints()">
                                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                            </button>
                            <button type="button" class="btn btn-outline" onclick="loadDefaultConfig()">
                                üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                            </button>
                        </div>
                    </div>

                    <div class="map-editor">
                        <div class="coordinates-display" id="coordinatesDisplay">
                            X: -, Y: -
                        </div>

                        <div class="editable-map" id="editableMap">
                            <img src="{{ url_for('static', filename='images/map.png') }}"
                                 alt="–ö–∞—Ä—Ç–∞"
                                 class="map-image"
                                 id="mapImage">
                            <div class="map-markers" id="mapMarkers"></div>
                        </div>

                        <div class="cell-info">
                            <div><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong></div>
                            <div>1. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –≤—ã—à–µ</div>
                            <div>2. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –≤ –Ω—É–∂–Ω–æ–µ –º–µ—Å—Ç–æ</div>
                            <div>3. –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è - –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º "–£–¥–∞–ª–∏—Ç—å" –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä</div>
                            <div>4. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–∞—Ä—Ç—ã</div>
                        </div>
                    </div>

                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö -->
                    <input type="hidden" name="start_point" id="startPoint" value="">
                    <input type="hidden" name="active_points" id="activePoints" value="">
                    <input type="hidden" name="checkpoints" id="checkpointsData" value="">
                </section>

                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–º–∏ —Ç–æ—á–∫–∞–º–∏ -->
                <section class="panel checkpoint-editor">
                    <h3 class="section-title">üèÅ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏</h3>

                    <div class="checkpoint-list" id="checkpointList">
                        <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è JavaScript -->
                    </div>

                    <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ -->
                    <div class="checkpoint-form" id="checkpointForm" style="display: none;">
                        <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Ç–æ—á–∫–∏</h4>
                        <div class="form-row">
                            <input type="text" id="cpName" class="form-input-small" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏">
                            <input type="number" id="cpRequired" class="form-input-small" placeholder="–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–¥–∞—á" min="0">
                            <select id="cpIcon" class="form-input-small">
                                <option value="üèÅ">üèÅ –§–ª–∞–≥</option>
                                <option value="üèïÔ∏è">üèïÔ∏è –õ–∞–≥–µ—Ä—å</option>
                                <option value="üèîÔ∏è">üèîÔ∏è –ì–æ—Ä–∞</option>
                                <option value="üè∞">üè∞ –ó–∞–º–æ–∫</option>
                                <option value="üå≤">üå≤ –õ–µ—Å</option>
                                <option value="üöÄ">üöÄ –†–∞–∫–µ—Ç–∞</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <button type="button" class="btn" onclick="saveCheckpointSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button type="button" class="btn btn-outline" onclick="cancelCheckpointEdit()">‚ùå –û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </section>

                <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                <section class="panel">
                    <h2 class="section-title">‚ö° –î–µ–π—Å—Ç–≤–∏—è</h2>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-success" id="save-btn">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç—É
                        </button>

                        <button type="button" class="btn" onclick="previewMap()">
                            üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                        </button>

                        <button type="button" class="btn btn-outline" onclick="exportMapConfig()">
                            üì§ –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                        </button>
                    </div>

                    <div id="message-area" style="margin-top: 16px;"></div>
                </section>
            </form>
        </main>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        let mapConfig = {
            startPoint: null,      // {x: 15, y: 75}
            activePoints: [],      // [{x: 20, y: 80}, {x: 25, y: 75}, ...]
            checkpoints: []        // [{x: 40, y: 50, name: "–õ–µ—Å", required: 5, icon: "üå≤"}, ...]
        };

        let currentMode = 'start';
        let selectedCheckpoint = null;
        let mapRect = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        function initMapEditor() {
            setupEventListeners();
            updateMapDisplay();
            loadDefaultConfig();
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            const mapElement = document.getElementById('editableMap');
            const mapImage = document.getElementById('mapImage');

            // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
            mapElement.addEventListener('click', function(e) {
                if (currentMode === 'delete') return;

                const rect = mapElement.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;

                handleMapClick(x, y);
            });

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –º—ã—à–∏
            mapElement.addEventListener('mousemove', function(e) {
                const rect = mapElement.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;

                document.getElementById('coordinatesDisplay').textContent =
                    `X: ${x.toFixed(1)}%, Y: ${y.toFixed(1)}%`;
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMode = this.dataset.mode;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
                    const display = document.getElementById('coordinatesDisplay');
                    if (currentMode === 'delete') {
                        display.innerHTML = '–†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è: –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä';
                    } else {
                        display.innerHTML = 'X: -, Y: -';
                    }
                });
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
            document.getElementById('map-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveMapConfig();
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
        function handleMapClick(x, y) {
            const point = { x: Math.round(x * 10) / 10, y: Math.round(y * 10) / 10 };

            switch (currentMode) {
                case 'start':
                    mapConfig.startPoint = point;
                    showMessage(`–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: (${point.x}%, ${point.y}%)`, 'success');
                    break;

                case 'active':
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–º –º–µ—Å—Ç–µ
                    const existingActive = mapConfig.activePoints.find(p =>
                        Math.abs(p.x - point.x) < 1 && Math.abs(p.y - point.y) < 1
                    );

                    if (!existingActive) {
                        mapConfig.activePoints.push(point);
                        showMessage(`–ê–∫—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: (${point.x}%, ${point.y}%)`, 'success');
                    } else {
                        showMessage('–¢–æ—á–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–º –º–µ—Å—Ç–µ', 'info');
                    }
                    break;

                case 'checkpoint':
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–º –º–µ—Å—Ç–µ
                    const existingCheckpoint = mapConfig.checkpoints.find(cp =>
                        Math.abs(cp.x - point.x) < 1 && Math.abs(cp.y - point.y) < 1
                    );

                    if (!existingCheckpoint) {
                        const newCheckpoint = {
                            ...point,
                            name: `–¢–æ—á–∫–∞ ${mapConfig.checkpoints.length + 1}`,
                            required: mapConfig.checkpoints.length + 1,
                            icon: 'üèÅ'
                        };
                        mapConfig.checkpoints.push(newCheckpoint);
                        showMessage(`–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: (${point.x}%, ${point.y}%)`, 'success');
                    } else {
                        showMessage('–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–º –º–µ—Å—Ç–µ', 'info');
                    }
                    break;
            }

            updateMapDisplay();
            updateHiddenFields();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏
        function deletePoint(x, y, type) {
            switch (type) {
                case 'start':
                    mapConfig.startPoint = null;
                    showMessage('–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'info');
                    break;

                case 'active':
                    mapConfig.activePoints = mapConfig.activePoints.filter(p =>
                        !(Math.abs(p.x - x) < 1 && Math.abs(p.y - y) < 1)
                    );
                    showMessage('–ê–∫—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'info');
                    break;

                case 'checkpoint':
                    mapConfig.checkpoints = mapConfig.checkpoints.filter(cp =>
                        !(Math.abs(cp.x - x) < 1 && Math.abs(cp.y - y) < 1)
                    );
                    showMessage('–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'info');
                    break;
            }

            updateMapDisplay();
            updateHiddenFields();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
        function updateMapDisplay() {
            const markersContainer = document.getElementById('mapMarkers');
            markersContainer.innerHTML = '';

            // –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞
            if (mapConfig.startPoint) {
                createMarker(mapConfig.startPoint, 'start', '–°—Ç–∞—Ä—Ç');
            }

            // –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ—á–∫–∏
            mapConfig.activePoints.forEach(point => {
                createMarker(point, 'active', '–ê–∫—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞');
            });

            // –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏
            mapConfig.checkpoints.forEach(checkpoint => {
                createMarker(checkpoint, 'checkpoint', checkpoint.name);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateStatistics();
            updateCheckpointList();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
        function createMarker(point, type, title) {
            const marker = document.createElement('div');
            marker.className = `marker marker-${type}`;
            marker.style.left = point.x + '%';
            marker.style.top = point.y + '%';
            marker.title = `${title} (${point.x}%, ${point.y}%)`;

            // –î–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫ –¥–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
            if (type === 'checkpoint') {
                const icon = document.createElement('div');
                icon.textContent = point.icon;
                icon.style.position = 'absolute';
                icon.style.top = '-8px';
                icon.style.left = '-8px';
                icon.style.fontSize = '12px';
                marker.appendChild(icon);
            }

            marker.addEventListener('click', function(e) {
                e.stopPropagation();

                if (currentMode === 'delete') {
                    deletePoint(point.x, point.y, type);
                } else if (type === 'checkpoint') {
                    editCheckpoint(point);
                }
            });

            document.getElementById('mapMarkers').appendChild(marker);
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Ç–æ—á–∫–∏
        function editCheckpoint(point) {
            const checkpoint = mapConfig.checkpoints.find(cp =>
                Math.abs(cp.x - point.x) < 1 && Math.abs(cp.y - point.y) < 1
            );

            if (checkpoint) {
                selectedCheckpoint = checkpoint;
                document.getElementById('cpName').value = checkpoint.name;
                document.getElementById('cpRequired').value = checkpoint.required;
                document.getElementById('cpIcon').value = checkpoint.icon;
                document.getElementById('checkpointForm').style.display = 'block';
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Ç–æ—á–∫–∏
        function saveCheckpointSettings() {
            if (selectedCheckpoint) {
                selectedCheckpoint.name = document.getElementById('cpName').value;
                selectedCheckpoint.required = parseInt(document.getElementById('cpRequired').value);
                selectedCheckpoint.icon = document.getElementById('cpIcon').value;

                document.getElementById('checkpointForm').style.display = 'none';
                updateMapDisplay();
                updateHiddenFields();
                showMessage('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            }
        }

        // –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function cancelCheckpointEdit() {
            document.getElementById('checkpointForm').style.display = 'none';
            selectedCheckpoint = null;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStatistics() {
            document.getElementById('statActive').textContent = mapConfig.activePoints.length;
            document.getElementById('statCheckpoints').textContent = mapConfig.checkpoints.length;
            document.getElementById('statStart').textContent = mapConfig.startPoint ? '‚úì' : '-';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫
        function updateCheckpointList() {
            const list = document.getElementById('checkpointList');
            list.innerHTML = '';

            mapConfig.checkpoints.forEach((checkpoint, index) => {
                const item = document.createElement('div');
                item.className = 'checkpoint-item';
                item.innerHTML = `
                    <div class="checkpoint-details">
                        <strong>${checkpoint.icon} ${checkpoint.name}</strong>
                        <div class="checkpoint-coords">(${checkpoint.x}%, ${checkpoint.y}%) - —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–¥–∞—á: ${checkpoint.required}</div>
                    </div>
                    <div class="checkpoint-actions">
                        <button type="button" class="mini-btn btn-edit" onclick="editCheckpoint({x: ${checkpoint.x}, y: ${checkpoint.y}})">‚úèÔ∏è</button>
                        <button type="button" class="mini-btn btn-remove" onclick="deletePoint(${checkpoint.x}, ${checkpoint.y}, 'checkpoint')">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π
        function updateHiddenFields() {
            document.getElementById('startPoint').value = JSON.stringify(mapConfig.startPoint);
            document.getElementById('activePoints').value = JSON.stringify(mapConfig.activePoints);
            document.getElementById('checkpointsData').value = JSON.stringify(mapConfig.checkpoints);
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ç–æ—á–µ–∫
        function clearAllPoints() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï —Ç–æ—á–∫–∏ —Å –∫–∞—Ä—Ç—ã?')) {
                mapConfig.startPoint = null;
                mapConfig.activePoints = [];
                mapConfig.checkpoints = [];

                updateMapDisplay();
                updateHiddenFields();
                showMessage('–í—Å–µ —Ç–æ—á–∫–∏ —É–¥–∞–ª–µ–Ω—ã', 'success');
            }
        }

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
function loadSavedConfig() {
    fetch('/api/map/config')
        .then(response => response.json())
        .then(config => {
            mapConfig = {
                startPoint: config.start_point,
                activePoints: config.active_points || [],
                checkpoints: config.checkpoints || []
            };

            updateMapDisplay();
            updateHiddenFields();
            showMessage('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞', 'success');
        })
        .catch(error => {
            console.error('Error loading map config:', error);
            loadDefaultConfig();
        });
}

// –û–±–Ω–æ–≤–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
function initMapEditor() {
    setupEventListeners();
    updateMapDisplay();
    loadSavedConfig();  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞ –≤–º–µ—Å—Ç–æ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π
}
        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç—ã
        function previewMap() {
            const preview = JSON.stringify(mapConfig, null, 2);
            alert('–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:\n\n' + preview);
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        function exportMapConfig() {
            const dataStr = JSON.stringify(mapConfig, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'map_config.json';
            link.click();

            showMessage('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞', 'success');
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        function saveMapConfig() {
            const saveBtn = document.getElementById('save-btn');
            const originalText = saveBtn.innerHTML;

            saveBtn.innerHTML = '<span class="loading-spinner"></span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            saveBtn.disabled = true;

            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                showMessage('–ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
            }, 1500);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type) {
            const messageArea = document.getElementById('message-area');
            const messageClass = type === 'success' ? 'success-message' : 'error-message';

            messageArea.innerHTML = `
                <div class="${messageClass}" style="${type === 'error' ? 'background: rgba(239, 83, 80, 0.1); border: 1px solid #ef5350; color: #ef5350;' : ''}">
                    ${text}
                </div>
            `;

            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 3000);
        }

        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            initMapEditor();

            const currentPath = window.location.pathname;
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>