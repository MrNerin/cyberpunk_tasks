<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGG - QUEST</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <div class="mobile-menu-toggle" onclick="toggleSidebar()">
        <span>‚ò∞</span>
        <span>–ú–µ–Ω—é</span>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">RGG QUEST</div>
                <div class="sidebar-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</div>
            </div>

            <nav class="sidebar-nav">
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
                    <a href="/" class="sidebar-link active">
                        <span class="sidebar-link-icon">üìã</span>
                        <span class="sidebar-link-text">–ì–ª–∞–≤–Ω–∞—è</span>
                    </a>

                    <a href="/map" class="sidebar-link">
                        <span class="sidebar-link-icon">üó∫Ô∏è</span>
                        <span class="sidebar-link-text">–ö–∞—Ä—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</span>
                    </a>
                    <a href="/rules" class="sidebar-link">
    <span class="sidebar-link-icon">üìñ</span>
    <span class="sidebar-link-text">–ü—Ä–∞–≤–∏–ª–∞</span>
</a>
                    <a href="/archive" class="sidebar-link">
                        <span class="sidebar-link-icon">üìö</span>
                        <span class="sidebar-link-text">–ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á</span>
                    </a>
                </div>

                {% if session.role == 'admin' %}
                <div class="sidebar-section">
                    <div class="sidebar-section-title">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                    <a href="/admin" class="sidebar-link">
                        <span class="sidebar-link-icon">‚öôÔ∏è</span>
                        <span class="sidebar-link-text">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
                    </a>
                </div>
                {% endif %}
            </nav>

            <!-- User Info -->
            <div class="sidebar-user">
                {% if 'username' in session %}
                <div class="user-profile">
                    <div class="user-avatar-large">
                        {{ session.username[0]|upper }}
                    </div>
                    <div class="user-info-compact">
                        <div class="user-name">{{ session.username }}</div>
                        <div class="user-role">{{ session.role }}</div>
                    </div>
                    <a href="/logout" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8em;">–í—ã–π—Ç–∏</a>
                </div>
                {% else %}
                <div style="display: flex; gap: 8px; flex-direction: column;">
                    <a href="/login" class="btn" style="width: 100%; text-align: center;">–í–æ–π—Ç–∏</a>
                    <a href="/register" class="btn btn-outline" style="width: 100%; text-align: center;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                </div>
                {% endif %}
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
            <div style="margin-bottom: 32px;">
                <h1 class="title">–ü–æ–ø—ã—Ç–∫–∞ –≤ RGG</h1>
                <p class="subtitle">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</p>
            </div>

            <!-- User Stats -->
            {% if 'username' in session %}
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-value">{{ user_daily_done|length }}/3</div>
                    <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ (user_daily_done|length / 3 * 100) | round | int }}%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ total_completed }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ session.role|upper }}</div>
                    <div class="stat-label">–í–∞—à —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞</div>
                </div>
            </div>
            {% endif %}

            <!-- Daily Tasks -->
            <section class="panel">
                <h2 class="section-title">üìÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    –í—ã–ø–æ–ª–Ω—è–π—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                </p>

                {% if daily %}
                <div class="tasks-list">
                    {% for task in daily %}
                    <div class="card">
                        <div class="card-content">
                            <div class="card-text">{{ task }}</div>
                            <div class="card-actions">
                                {% if 'username' in session %}
                                    {% if task not in user_daily_done %}
                                    <form method="post" action="/mark_daily_done" style="display: inline;">
                                        <input type="hidden" name="task" value="{{ task }}">
                                        <button type="submit" class="btn btn-success">
                                            ‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç—å
                                        </button>
                                    </form>
                                    {% else %}
                                    <span class="status status-done">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                                    {% endif %}
                                {% else %}
                                    <a href="/login" class="btn btn-outline">–í–æ–π—Ç–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üìÖ</div>
                    <p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–¥–∞—á –Ω–µ—Ç</p>
                </div>
                {% endif %}
            </section>

            <!-- Task Board -->
            <section class="panel">
                <h2 class="section-title">üìã –î–æ—Å–∫–∞ –∑–∞–¥–∞—á</h2>

                {% if board %}
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>–ó–∞–¥–∞—á–∞</th>
                                <th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in board %}
                            {% if task.status != 'done' %}
                            <tr>
                                <td>{{ task.text }}</td>
                                <td>
                                    <span class="difficulty difficulty-{{ task.difficulty|lower }}">
                                        {{ task.difficulty }}
                                    </span>
                                </td>
                                <td>
                                    <span class="status status-{{ task.status }}">
                                        {% if task.status == 'free' %}–°–≤–æ–±–æ–¥–Ω–∞{% endif %}
                                        {% if task.status == 'taken' %}–í —Ä–∞–±–æ—Ç–µ{% endif %}
                                        {% if task.status == 'done' %}–í—ã–ø–æ–ª–Ω–µ–Ω–∞{% endif %}
                                    </span>
                                </td>
                                <td>{{ task.user or '‚Äî' }}</td>
                                <td>
                                    {% if 'username' not in session %}
                                        <a href="/login" class="btn btn-outline">–í–æ–π—Ç–∏</a>
                                    {% elif task.status == 'free' %}
                                        <form method="post" action="/board/take/{{ task.id }}" style="display: inline;">
                                            <button type="submit" class="btn">–í–∑—è—Ç—å –∑–∞–¥–∞—á—É</button>
                                        </form>
                                    {% elif task.status == 'taken' and task.user == session.get('username') %}
                                        <form method="post" action="/board/done/{{ task.id }}" style="display: inline;">
                                            <button type="submit" class="btn btn-success">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                                        </form>
                                    {% elif task.status == 'taken' %}
                                        <span style="color: var(--text-secondary);">–ó–∞–Ω—è—Ç–æ: {{ task.user }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <p>–ù–∞ –¥–æ—Å–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</p>
                    {% if session.role == 'admin' %}
                    <a href="/admin" class="btn" style="margin-top: 16px;">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á–∏</a>
                    {% endif %}
                </div>
                {% endif %}
            </section>
        </main>
    </div>

    <script>
        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        // Close sidebar when clicking on a link (mobile)
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });

            // Form handling
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function() {
                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        const originalText = submitBtn.innerHTML;
                        submitBtn.innerHTML = '<span class="loading-spinner"></span> –û–±—Ä–∞–±–æ—Ç–∫–∞...';
                        submitBtn.disabled = true;

                        setTimeout(() => {
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        }, 2000);
                    }
                });
            });

            // Update active link based on current page
            const currentPath = window.location.pathname;
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>