<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGG QUEST - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <div class="mobile-menu-toggle" onclick="toggleSidebar()">
        <span>‚ò∞</span>
        <span>–ú–µ–Ω—é</span>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">RGG QUEST</div>
                <div class="sidebar-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
                    <a href="/" class="sidebar-link active">
                        <span class="sidebar-link-icon">üìã</span>
                        <span class="sidebar-link-text">–ì–ª–∞–≤–Ω–∞—è</span>
                    </a>
                    <a href="/map" class="sidebar-link">
                        <span class="sidebar-link-icon">üó∫Ô∏è</span>
                        <span class="sidebar-link-text">–ö–∞—Ä—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</span>
                    </a>
                    <a href="/archive" class="sidebar-link">
                        <span class="sidebar-link-icon">üìö</span>
                        <span class="sidebar-link-text">–ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á</span>
                    </a>
                </div>

                {% if session.role == 'admin' %}
                <div class="sidebar-section">
                    <div class="sidebar-section-title">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                    <a href="/admin" class="sidebar-link">
                        <span class="sidebar-link-icon">‚öôÔ∏è</span>
                        <span class="sidebar-link-text">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
                    </a>
                    <a href="/map_editor" class="sidebar-link">
                        <span class="sidebar-link-icon">üé®</span>
                        <span class="sidebar-link-text">–†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã</span>
                    </a>
                </div>
                {% endif %}

                <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
                    <div class="quick-actions">
                        <a href="/map" class="action-button">
                            <span class="action-button-icon">üó∫Ô∏è</span>
                            <span class="action-button-text">–ù–∞ –∫–∞—Ä—Ç—É</span>
                        </a>
                        <a href="/archive" class="action-button">
                            <span class="action-button-icon">üìö</span>
                            <span class="action-button-text">–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö</span>
                        </a>
                        {% if session.role == 'admin' %}
                        <a href="/admin" class="action-button">
                            <span class="action-button-icon">‚öôÔ∏è</span>
                            <span class="action-button-text">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </nav>

            <!-- User Info -->
            <div class="sidebar-user">
                {% if 'username' in session %}
                <div class="user-profile">
                    <div class="user-avatar-large">
                        {{ session.username[0]|upper }}
                    </div>
                    <div class="user-info-compact">
                        <div class="user-name">{{ session.username }}</div>
                        <div class="user-role">{{ session.role }}</div>
                        <div class="user-coins">üí∞ {{ user_coins }} –º–æ–Ω–µ—Ç</div>
                    </div>
                    <a href="/logout" class="btn btn-outline logout-btn">–í—ã–π—Ç–∏</a>
                </div>
                {% else %}
                <div class="auth-buttons">
                    <a href="/login" class="btn login-btn">–í–æ–π—Ç–∏</a>
                    <a href="/register" class="btn btn-outline register-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                </div>
                {% endif %}
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <h1 class="title">RGG QUEST</h1>
            <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</p>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            {% if 'username' in session %}
            <div class="stats-panel">
                <div class="stat-card coins-stat">
                    <div class="stat-value">üí∞ {{ user_coins }}</div>
                    <div class="stat-label">–ú–æ–Ω–µ—Ç–æ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ total_completed }}</div>
                    <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ daily|length - user_daily_done|length }}</div>
                    <div class="stat-label">–û—Å—Ç–∞–ª–æ—Å—å —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
            </div>

            <!-- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ -->
            <section class="panel daily-tasks-panel">
                <div class="panel-header">
                    <h2 class="section-title">üìÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
                    <div class="date-badge">{{ today_date }}</div>
                </div>
                <div class="daily-tasks-grid">
                    {% for task in daily %}
                    <div class="daily-task-card {% if task in user_daily_done %}completed{% endif %}">
                        <div class="task-main-content">
                            <div class="task-checkbox">
                                {% if task in user_daily_done %}
                                <div class="checkbox checked">‚úì</div>
                                {% else %}
                                <div class="checkbox"></div>
                                {% endif %}
                            </div>
                            <div class="task-text-content">
                                <div class="task-text">{{ task }}</div>
                                <div class="task-status">
                                    {% if task in user_daily_done %}
                                    <span class="status-completed">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                                    {% else %}
                                    <span class="status-pending">–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="task-actions">
                            {% if task not in user_daily_done %}
                            <form action="/mark_daily_done" method="POST" class="task-form">
                                <input type="hidden" name="task" value="{{ task }}">
                                <button type="submit" class="btn-action btn-complete" title="–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º">
                                    ‚úÖ
                                </button>
                            </form>
                            {% else %}
                            <form action="/unmark_daily_done" method="POST" class="task-form">
                                <input type="hidden" name="task" value="{{ task }}">
                                <button type="submit" class="btn-action btn-cancel" title="–û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ">
                                    ‚ùå
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- –î–æ—Å–∫–∞ –∑–∞–¥–∞—á -->
            <section class="panel">
                <h2 class="section-title">üìã –î–æ—Å–∫–∞ –∑–∞–¥–∞—á</h2>
                <div class="board-tasks">
                    {% for task in board %}
                    <div class="board-task-card {% if task.status == 'done' %}completed{% elif task.status == 'taken' %}taken{% endif %}">
                        <div class="task-header">
                            <span class="task-difficulty {{ task.difficulty }}">{{ task.difficulty }}</span>
                            <span class="task-id">#{{ task.id }}</span>
                        </div>
                        <div class="task-text">{{ task.text }}</div>
                        <div class="task-info">
                            {% if task.status == 'free' %}
                            <form action="/board/take/{{ task.id }}" method="POST">
                                <button type="submit" class="btn btn-secondary">üì• –í–∑—è—Ç—å –∑–∞–¥–∞—á—É</button>
                            </form>
                            {% elif task.status == 'taken' %}
                            <div class="task-status-info">
                                <span>–í–∑—è—Ç–∞: <span class="user-link">{{ task.user }}</span></span>
                                {% if task.user == session.username %}
                                <form action="/board/done/{{ task.id }}" method="POST">
                                    <button type="submit" class="btn btn-success">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                                </form>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="task-status-info completed">
                                <span>–í—ã–ø–æ–ª–Ω–µ–Ω–∞: <span class="user-link">{{ task.user }}</span></span>
                                <span class="task-date">{{ task.done_at }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}

                    {% if not board %}
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>–ù–µ—Ç –∑–∞–¥–∞—á –Ω–∞ –¥–æ—Å–∫–µ</h3>
                        <p>–ó–∞–¥–∞—á–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å —Å–∫–æ—Ä–æ</p>
                    </div>
                    {% endif %}
                </div>
            </section>

            {% else %}
            <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö -->
            <section class="panel">
                <div class="empty-state">
                    <div class="empty-state-icon">üöÄ</div>
                    <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ RGG QUEST!</h3>
                    <p>–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–≤–æ–π –ø—É—Ç—å –∫ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤—É</p>
                    <div class="auth-buttons-center">
                        <a href="/login" class="btn">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a>
                        <a href="/register" class="btn btn-outline">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    </div>
                </div>
            </section>
            {% endif %}
        </main>
    </div>

    <script>
        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        // Close sidebar when clicking on a link (mobile)
        document.querySelectorAll('.sidebar-link, .action-button, .btn, .logout-btn, .login-btn, .register-btn').forEach(link => {
            link.addEventListener('click', (e) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ –∫–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –≤ –∑–∞–¥–∞—á–µ
                if (!e.target.closest('.btn-action') && !e.target.closest('.task-form')) {
                    if (window.innerWidth <= 768) {
                        toggleSidebar();
                    }
                }
            });
        });

        // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
        document.addEventListener('DOMContentLoaded', function() {
            // Update active link based on current page
            const currentPath = window.location.pathname;
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
            document.querySelectorAll('.checkbox').forEach(checkbox => {
                checkbox.addEventListener('click', function() {
                    const taskCard = this.closest('.daily-task-card');
                    const isCompleted = taskCard.classList.contains('completed');
                    const form = taskCard.querySelector('.task-form');

                    if (form) {
                        form.submit();
                    }
                });
            });
        });
    </script>
</body>
</html>